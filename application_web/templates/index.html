<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitesses - Dashboard</title>

    <!-- Bootstrap / Icons / Leaflet -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        /* Style modern et ultra propre */
        :root {
            --bg: #f5f6fa;
            --card: #ffffff;
            --text: #2d3436;
            --muted: #636e72;
            --blue: #0984e3;
            --red: #d63031;
            --orange: #e17055;
            --shadow: rgba(0,0,0,0.05);
        }

        body {
            background: var(--bg);
            font-family: 'Inter', 'Segoe UI', sans-serif;
            color: var(--text);
            padding-bottom: 40px;
        }

        .navbar {
            background: white;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.4rem;
            letter-spacing: -0.5px;
        }

        /* ========== CARDS ULTRA PROPRES ========== */
        .card-clean {
            background: var(--card);
            border-radius: 18px;
            border: none;
            padding: 28px;
            box-shadow: 0 4px 20px var(--shadow);
            transition: 0.25s ease;
        }

        .card-clean:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.08);
        }

        .kpi-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 4px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
        }

        .icon-bg {
            position: absolute;
            right: 20px;
            top: 20px;
            opacity: 0.12;
            font-size: 55px;
        }

        /* ========== MAP ========== */
        #map {
            height: 530px;
            width: 100%;
            border-radius: 16px;
        }

        /* ========== DETAILS PANEL ========== */
        .speed-number {
            font-size: clamp(2.7rem, 4.5vw, 4.4rem);
            font-weight: 900;
            color: var(--red);
        }

        .limit-tag {
            background: var(--text);
            color: white;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .detail-line {
            border-bottom: 1px solid #ececec;
            padding: 12px 0;
        }

        /* ========== GRAPH ========== */
        #chartDensite {
            height: 260px !important;
        }

        /* Animation clean */
        .fade-in {
            animation: fadeIn 0.35s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }

    </style>
</head>
<body>

<nav class="navbar px-4 py-3 d-flex align-items-center border-bottom bg-white shadow-sm">
    <div class="d-flex align-items-center">
        <i class="fas fa-gauge-high text-primary fs-4 me-2"></i>
        <span class="navbar-brand mb-0 h5 fw-bold">
            Projet <span class="text-primary">RCW</span>
        </span>
    </div>

    <div class="ms-auto d-flex align-items-center">
        <span class="fw-semibold text-secondary">
            Mohamed Jadid & Chadi Amestoun, TP 5B
        </span>
    </div>
</nav>


<div class="container-fluid px-4 px-lg-5 mt-4">

    <h1 class="text-center h3 mt-4 mb-3">
        Vitesses relevées par les voitures radars à conduite externalisée
    </h1>

    <p class="text-center mb-5">
        Ce tableau de bord analyse les vitesses enregistrées par les voitures-radars en France afin 
        de comprendre comment les infractions se répartissent sur le territoire. L’idée est de 
        mettre en lumière les zones où les comportements à risque sont les plus concentrés, et de 
        voir dans quelle mesure la taille du département ou sa configuration urbaine jouent un rôle.
    </p>

    <p class="text-center fw-semibold mt-4 mb-5">
        <strong>Problématique :</strong><br>
        Quels départements français présentent le plus fort taux d’infractions, en tenant compte de la superficie et des caractéristiques du territoire ?
    </p>

    <!-- KPIs -->
    <div class="row g-4 mb-4">

        <div class="col-sm-6 col-xl-3 position-relative">
            <div class="card-clean">
                <div class="kpi-label">Total Infractions</div>
                <div class="kpi-value text-primary" id="kpi-total">...</div>
            </div>
            <i class="fas fa-file-invoice icon-bg text-primary"></i>
        </div>

        <div class="col-sm-6 col-xl-3 position-relative">
            <div class="card-clean">
                <div class="kpi-label">Vitesse Max</div>
                <div class="kpi-value text-danger" id="kpi-max">...</div>
            </div>
            <i class="fas fa-tachometer-alt icon-bg text-danger"></i>
        </div>

        <div class="col-sm-6 col-xl-3 position-relative">
            <div class="card-clean">
                <div class="kpi-label">Excès Moyen</div>
                <div class="kpi-value text-warning" id="kpi-moy">...</div>
            </div>
            <i class="fas fa-chart-line icon-bg text-warning"></i>
        </div>

        <div class="col-sm-6 col-xl-3 position-relative">
            <div class="card-clean">
                <div class="kpi-label">Zone Critique</div>
                <div class="kpi-value text-success" id="kpi-top" style="font-size:1.4rem;">...</div>
            </div>
            <i class="fas fa-map-marker-alt icon-bg text-success"></i>
        </div>

    </div>

    <div class="row g-4 mb-4">

        <!-- MAP -->
        <div class="col-lg-8">
            <div class="card-clean p-0 overflow-hidden">
                <div class="p-4 border-bottom bg-white">
                    <h5 class="fw-bold m-0"><i class="fas fa-map me-2 text-primary"></i> Localisation des Infractions</h5>
                </div>
                <div id="map"></div>
            </div>
        </div>

        <!-- DETAILS -->
        <div class="col-lg-4">
            <div class="card-clean">
                <h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2 text-primary"></i>Détails de l'infraction</h5>

                <div id="state-empty" class="text-center text-muted py-5">
                    <i class="fas fa-location-arrow fa-3x mb-3 opacity-50"></i>
                    <p>Clique sur un point pour afficher les infos.</p>
                </div>

                <div id="state-selected" style="display:none;" class="fade-in">
                    <div class="text-center mb-3">
                        <span class="text-uppercase small text-muted fw-bold">Vitesse retenue</span>
                        <div class="speed-number"><span id="val-vitesse">0</span> km/h</div>
                        <span class="limit-tag">Limite : <span id="val-limite">0</span> km/h</span>
                    </div>

                    <div class="detail-line d-flex justify-content-between">
                        <span class="text-muted small fw-bold">Dépassement</span>
                        <span class="fw-bold text-danger">+<span id="val-exces">0</span> km/h</span>
                    </div>

                    <div class="detail-line">
                        <span class="text-muted small fw-bold d-block mb-1">Localisation GPS</span>
                        <span class="small text-muted"><i class="fas fa-satellite me-2"></i><span id="val-gps">...</span></span>
                    </div>

                    <a id="btn-gmaps" href="#" target="_blank" class="btn btn-outline-primary w-100 mt-3 fw-semibold">
                        <i class="fas fa-map-location-dot me-2"></i>Ouvrir dans Maps
                    </a>
                </div>
            </div>
        </div>

    </div>

    <!-- GRAPH -->
    <div class="row g-4">
        <div class="col-12">
            <div class="card-clean">
                <h5 class="fw-bold mb-3"><i class="fas fa-chart-column me-2 text-primary"></i>Densité par Zone (Top 15)</h5>
                <canvas id="chartDensite"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    /*==============================
      CONFIGURATION DE LA CARTE
    ==============================*/
    const map = L.map('map').setView([46.6, 2.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    const markers = L.markerClusterGroup({ showCoverageOnHover: false });

    /*==============================
      CHARGEMENT DES POINTS (/api/carte)
    ==============================*/
    fetch('/api/carte')
        .then(r => {
            if (!r.ok) throw new Error('Erreur réseau');
            return r.json();
        })
        .then(data => {

            document.getElementById('kpi-total').innerText = data.length ?? 0;

            let maxSpeed = 0;
            let sumExces = 0;
            let countExces = 0;

            data.forEach(item => {
                const vit = parseFloat(item.vitesse) || 0;
                const lim = parseFloat(item.limite) || 0;
                const lat = parseFloat(item.lat) || 0;
                const lon = parseFloat(item.long) || 0;
                const exces = vit - lim;

                if (vit > maxSpeed) maxSpeed = vit;
                if (exces > 0) { sumExces += exces; countExces++; }

                let color = '#e1b12c';
                if (exces > 20) color = '#e17055';
                if (exces > 40) color = '#d63031';

                const marker = L.circleMarker([lat, lon], {
                    radius: 8,
                    fillColor: color,
                    fillOpacity: 0.95,
                    color: '#fff',
                    weight: 1
                });

                marker.on('click', () => {
                    document.getElementById('state-empty').style.display = 'none';

                    const panel = document.getElementById('state-selected');
                    // restart animation
                    panel.style.display = 'none';
                    setTimeout(() => panel.style.display = 'block', 12);

                    document.getElementById('val-vitesse').innerText = vit;
                    document.getElementById('val-limite').innerText = lim;
                    document.getElementById('val-exces').innerText = excessToStr(exces);
                    document.getElementById('val-gps').innerText = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                    document.getElementById('btn-gmaps').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
                });

                markers.addLayer(marker);
            });

            map.addLayer(markers);

            document.getElementById('kpi-max').innerText = (maxSpeed ? maxSpeed + ' km/h' : 'N/A');

            // moyenne d'excès par infraction (on divise par le nombre total d'items pour garder cohérence)
            const avg = data.length ? (sumExces / data.length).toFixed(1) : '0.0';
            document.getElementById('kpi-moy').innerText = '+' + avg + ' km/h';

        })
        .catch(err => {
            console.error('Erreur chargement carte:', err);
            document.getElementById('kpi-total').innerText = 'Erreur';
            document.getElementById('kpi-max').innerText = 'Erreur';
            document.getElementById('kpi-moy').innerText = 'Erreur';
        });

    function excessToStr(v) {
        if (Number.isFinite(v)) return (v > 0 ? v.toFixed(1) : '0.0');
        return '0.0';
    }

    /*==============================
      CHARGEMENT DENSITE (/api/densite)
    ==============================*/
    fetch('/api/densite')
        .then(r => {
            if (!r.ok) throw new Error('Erreur réseau');
            return r.json();
        })
        .then(data => {
            // affichage zone critique
            if (Array.isArray(data) && data.length > 0) {
                document.getElementById('kpi-top').innerText = data[0].nom || 'N/A';
            } else {
                document.getElementById('kpi-top').innerText = 'N/A';
            }

            // préparation chart
            const labels = (data || []).map(d => d.nom || '');
            const values = (data || []).map(d => Number(d.densite) || 0);

            const ctx = document.getElementById('chartDensite').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Densité',
                        data: values,
                        backgroundColor: '#3b82f6',
                        borderRadius: 8,
                        barThickness: 'flex',
                        maxBarThickness: 36
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [3,4] } },
                        x: { grid: { display: false } }
                    }
                }
            });

        })
        .catch(err => {
            console.error('Erreur chargement densite:', err);
        });

</script>

</body>
</html>