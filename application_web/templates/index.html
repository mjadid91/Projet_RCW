<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observatoire des Vitesses - Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        :root {
            --primary-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-light: #95a5a6;
        }

        body { 
            background-color: var(--primary-bg); 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            color: var(--text-main);
            padding-bottom: 50px;
        }

        /* Navbar Modernisée */
        .navbar { 
            background: white; 
            padding: 1rem 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            margin-bottom: 2rem;
        }
        .navbar-brand { 
            font-weight: 800; 
            letter-spacing: -0.5px;
            color: var(--text-main) !important; 
        }

        /* KPI Cards Modernes */
        .kpi-card {
            background: white;
            border: none;
            border-radius: 16px;
            padding: 24px;
            height: 100%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .kpi-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.06);
        }
        .kpi-label { 
            font-size: 0.85rem; 
            color: var(--text-light); 
            font-weight: 600; 
            text-transform: uppercase; 
            margin-bottom: 5px;
        }
        .kpi-value { 
            font-size: 2.2rem; 
            font-weight: 800; 
            line-height: 1.1;
        }
        .kpi-icon-wrapper {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            opacity: 0.15;
        }

        /* Dashboard Content Cards */
        .dashboard-card {
            background: white;
            border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            padding: 25px;
            height: 100%; 
            display: flex;
            flex-direction: column;
        }

        h3 { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: var(--text-main); 
            margin-bottom: 20px; 
            display: flex;
            align-items: center;
        }

        /* Map Fix */
        #map { 
            flex-grow: 1; 
            min-height: 500px; 
            border-radius: 12px; 
            width: 100%; 
            z-index: 1;
        }

        /* Détails Infraction */
        .details-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        /* Typography responsive pour éviter le dépassement */
        .big-speed { 
            font-size: clamp(2.5rem, 4vw, 4.5rem); 
            font-weight: 800; 
            color: #e74c3c; 
            line-height: 1;
        }
        
        .limit-badge { 
            background: #2c3e50; 
            color: white; 
            padding: 6px 14px; 
            border-radius: 30px; 
            font-weight: 600;
            font-size: 0.9rem; 
        }

        .detail-row { 
            margin-top: 15px; 
            padding: 12px 0; 
            border-bottom: 1px solid #f0f0f0; 
        }
        .detail-label { 
            font-size: 0.8rem; 
            color: var(--text-light); 
            font-weight: 700; 
            text-transform: uppercase; 
        }
        .detail-val { font-weight: 700; font-size: 1.1rem; }

        /* Animation */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Empty State */
        .empty-state {
            color: var(--text-light);
            text-align: center;
            padding: 40px 20px;
        }
        .empty-state i { opacity: 0.3; margin-bottom: 20px; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="container-fluid px-5">
        <a class="navbar-brand" href="#"><i class="fas fa-radar text-primary me-2"></i> Observatoire <span class="text-primary">Vitesse</span></a>
    </div>
</nav>

<div class="container-fluid px-4 px-lg-5">
    
    <div class="row g-4 mb-4">
        <div class="col-sm-6 col-xl-3">
            <div class="kpi-card">
                <div class="kpi-label">Total Infractions</div>
                <div class="kpi-value text-primary" id="kpi-total">...</div>
                <div class="kpi-icon-wrapper bg-primary text-primary">
                    <i class="fas fa-file-invoice"></i>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="kpi-card">
                <div class="kpi-label">Vitesse Max</div>
                <div class="kpi-value text-danger" id="kpi-max">...</div>
                <div class="kpi-icon-wrapper bg-danger text-danger">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="kpi-card">
                <div class="kpi-label">Excès Moyen</div>
                <div class="kpi-value text-warning" id="kpi-moy">...</div>
                <div class="kpi-icon-wrapper bg-warning text-warning">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="kpi-card">
                <div class="kpi-label">Zone Critique</div>
                <div class="kpi-value text-success" id="kpi-top" style="font-size: 1.5rem; word-break: break-word;">...</div>
                <div class="kpi-icon-wrapper bg-success text-success">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4 align-items-stretch"> 
        
        <div class="col-lg-8">
            <div class="dashboard-card p-0 overflow-hidden">
                <div class="p-4 border-bottom bg-white z-2 position-relative">
                   <h3 class="m-0"><i class="fas fa-map-marked-alt me-2 text-primary"></i> Localisation des Infractions</h3>
                </div>
                <div id="map"></div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="dashboard-card">
                <h3><i class="fas fa-info-circle me-2 text-primary"></i> Détails de l'infraction</h3>
                
                <div class="details-container">
                    
                    <div id="state-empty" class="empty-state">
                        <i class="fas fa-mouse-pointer fa-4x"></i>
                        <h5>Aucune sélection</h5>
                        <p class="small">Cliquez sur un point de la carte pour afficher le rapport détaillé de l'infraction.</p>
                    </div>

                    <div id="state-selected" style="display:none;" class="fade-in">
                        
                        <div class="text-center py-4">
                            <div class="text-uppercase text-light fw-bold small mb-2" style="letter-spacing: 2px;">VITESSE RETENUE</div>
                            <div class="big-speed"><span id="val-vitesse">0</span> <span style="font-size:1.5rem; color:#ccc;">km/h</span></div>
                            <div class="mt-2">
                                <span class="limit-badge">Limite : <span id="val-limite">0</span> km/h</span>
                            </div>
                        </div>
                        
                        <div class="px-2">
                            <div class="detail-row d-flex justify-content-between align-items-center">
                                <span class="detail-label">Dépassement</span>
                                <span class="detail-val text-danger">+<span id="val-exces">0</span> km/h</span>
                            </div>

                            <div class="detail-row">
                                <span class="detail-label d-block mb-1">Localisation GPS</span>
                                <span class="text-muted small font-monospace"><i class="fas fa-satellite me-2"></i><span id="val-gps">...</span></span>
                            </div>

                            <div class="mt-4 pt-3">
                                <a href="#" target="_blank" id="btn-gmaps" class="btn btn-outline-primary w-100 py-2 rounded-3 fw-bold">
                                    <i class="fas fa-external-link-alt me-2"></i> Ouvrir dans Maps
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12">
            <div class="dashboard-card">
                <h3><i class="fas fa-chart-bar me-2 text-primary"></i> Densité par Zone (Top 15)</h3>
                <div style="height: 250px; width: 100%;">
                    <canvas id="chartDensite"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    // --- 1. CONFIGURATION CARTE ---
    const map = L.map('map').setView([46.6, 2.5], 6); // Centre de la France
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap, © CARTO',
        maxZoom: 19
    }).addTo(map);

    const markers = L.markerClusterGroup({
        showCoverageOnHover: false
    });

    // --- 2. RECUPERATION DES DONNÉES CARTE (/api/carte) ---
    fetch('/api/carte')
        .then(response => response.json())
        .then(data => {
            // Mise à jour du KPI Total
            document.getElementById('kpi-total').innerText = data.length;

            let maxSpeed = 0;
            let totalExces = 0;

            data.forEach(item => {
                // Parsing des données (car SPARQL renvoie souvent des strings)
                const vit = parseFloat(item.vitesse);
                const lim = parseFloat(item.limite);
                const lat = parseFloat(item.lat);
                const long = parseFloat(item.long);
                
                const exces = (vit - lim);

                // Calculs statistiques
                if(vit > maxSpeed) maxSpeed = vit;
                if(exces > 0) totalExces += exces;

                // Couleur selon gravité
                let color = '#f1c40f'; // Jaune
                if (exces > 20) color = '#e67e22'; // Orange
                if (exces > 40) color = '#e74c3c'; // Rouge

                const marker = L.circleMarker([lat, long], {
                    color: 'white', 
                    weight: 1,
                    fillColor: color, 
                    fillOpacity: 0.9, 
                    radius: 8
                });

                // INTERACTION AU CLIC
                marker.on('click', function() {
                    // Reset UI
                    document.getElementById('state-empty').style.display = 'none';
                    const selectedDiv = document.getElementById('state-selected');
                    selectedDiv.style.display = 'none'; // Hack pour rejouer l'animation
                    setTimeout(() => { selectedDiv.style.display = 'block'; }, 10);

                    // Update Data dans le panneau latéral
                    document.getElementById('val-vitesse').innerText = vit;
                    document.getElementById('val-limite').innerText = lim;
                    document.getElementById('val-exces').innerText = exces.toFixed(1);
                    document.getElementById('val-gps').innerText = `${lat.toFixed(4)}, ${long.toFixed(4)}`;
                    
                    // Lien Google Maps correct
                    const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${long}`;
                    document.getElementById('btn-gmaps').href = gmapsUrl;
                });

                markers.addLayer(marker);
            });

            // Ajout des marqueurs à la carte
            map.addLayer(markers);

            // Mise à jour des KPIs restants
            document.getElementById('kpi-max').innerText = maxSpeed + " km/h";
            
            // Calcul moyenne (évite division par zéro)
            const moy = data.length > 0 ? (totalExces / data.length).toFixed(1) : 0;
            document.getElementById('kpi-moy').innerText = "+" + moy + " km/h";

        })
        .catch(error => {
            console.error('Erreur chargement carte:', error);
            document.getElementById('kpi-total').innerText = "Erreur";
        });

    // --- 3. RECUPERATION DES DONNÉES DENSITÉ (/api/densite) ---
    fetch('/api/densite')
        .then(response => response.json())
        .then(data => {
            
            // KPI Zone Critique (Le premier élément du tableau car trié DESC)
            if (data.length > 0) {
                document.getElementById('kpi-top').innerText = data[0].nom;
            } else {
                document.getElementById('kpi-top').innerText = "N/A";
            }

            // Préparation du Graphique
            const labels = data.map(item => item.nom);
            const values = data.map(item => item.densite);

            const ctx = document.getElementById('chartDensite').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Densité (Infractions / Superficie)',
                        data: values,
                        backgroundColor: '#3498db',
                        borderRadius: 6,
                        barThickness: 'flex',
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        })
        .catch(error => console.error('Erreur chargement densité:', error));

</script>

</body>
</html>